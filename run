#!/bin/bash

# creating secret rndc.key
# openssl rand -base64 15

: ${BIND_RNDCKEY:="D9yVnKTEXtrdHA=="}
: ${BIND_DIRECTORY:="/var/cache/bind/"}
: ${BIND_MEMSTATISTICSFILE:="/var/cache/bind/named.memstats"}
: ${BIND_DUMPFILE:="/var/cache/bind/named_dump.db"}
: ${BIND_LOCKFILE:="/var/run/named/named.lock"}
: ${BIND_PIDFILE:="/var/run/named/named.pid"}
: ${BIND_RECURSINGFILE:="/var/cache/bind/named.recursing"}
: ${BIND_STATISTICSFILE:="/var/cache/bind/named.stats"}
: ${BIND_BINDKEYSFILE:="/etc/bind/bind.keys"}
: ${BIND_SECROOTSFILE:="/var/cache/bind/named.secroots"}
: ${BIND_SESSIONKEYFILE:="/var/run/named/session.key"}
: ${BIND_SESSIONKEYALG:="hmac-sha256"}
: ${BIND_PORT:="53"}
: ${BIND_RANDOMDEVICE:="/dev/random"}
: ${BIND_VERSION:="none"}
: ${BIND_LISTENONPORT:="53"}
: ${BIND_LISTENON:="any"}
: ${BIND_LISTENONPORTV6:="53"}
: ${BIND_LISTENONV6:="none"}
: ${BIND_AUTOMATICINTERFACESCAN:="yes"}
: ${BIND_ALLOWNEWZONES:="no"}
: ${BIND_FLUSHZONESONSHUTDOWN:="no"}
: ${BIND_GEOIPUSEECS:="yes"}
: ${BIND_ROOTKEYSENTINEL:="yes"}
: ${BIND_MESSAGECOMPRESSION:="yes"}
: ${BIND_MINIMALRESPONSES:="no"}
: ${BIND_MINIMALANY:="no"}
: ${BIND_NOTIFY:="yes"}
: ${BIND_RECURSION:="yes"}
: ${BIND_REQUESTNSID:="no"}
: ${BIND_ANSWERCOOKIE:="yes"}
: ${BIND_NOCOOKIEUDPSIZE:="4096"}
: ${BIND_COOKIEALGORITHM:="aes"}
: ${BIND_ADDITIONALFROMAUTH:="yes"}
: ${BIND_ADDITIONALFROMCACHE:="yes"}
: ${BIND_FILTERAAAAONV4:="no"}
: ${BIND_FILTERAAAAONV6:="no"}
: ${BIND_IXFRFROMDIFFERENCES:="no"}
: ${BIND_MULTIMASTER:="no"}
: ${BIND_AUTODNSSEC:="off"}
: ${BIND_DNSSECVALIDATION:="auto"}
: ${BIND_DNSSECENABLE:="yes"}
: ${BIND_DNSSECACCEPTEXPIRED:="no"}
: ${BIND_CHECKNAMESMASTER:="fail"}
: ${BIND_CHECKNAMESSLAVE:="warn"}
: ${BIND_CHECKNAMESRESPONSE:="ignore"}
: ${BIND_CHECKDUPRECORDS:="warn"}
: ${BIND_CHECKMX:="warn"}
: ${BIND_CHECKWILDCARD:="yes"}
: ${BIND_CHECKINTEGRITY:="yes"}
: ${BIND_CHECKMXCNAME:="warn"}
: ${BIND_CHECKSRVCNAME:="warn"}
: ${BIND_CHECKSIBLING:="yes"}
: ${BIND_CHECKSPF:="warn"}
: ${BIND_ZERONOSOATTL:="yes"}
: ${BIND_ZERONOSOATTLCACHE:="no"}
: ${BIND_UPDATECHECKKSK:="yes"}
: ${BIND_DNSSECDNSKEYKSKONLY:="no"}
: ${BIND_TRYTCPREFRESH:="yes"}
: ${BIND_DNSSECSECURETOINSECURE:="no"}

CONFIGS_VARS=(
  BIND_RNDCKEY
  BIND_DIRECTORY
  BIND_MEMSTATISTICSFILE
  BIND_DUMPFILE
  BIND_LOCKFILE
  BIND_PIDFILE
  BIND_RECURSINGFILE
  BIND_STATISTICSFILE
  BIND_BINDKEYSFILE
  BIND_SECROOTSFILE
  BIND_SESSIONKEYFILE
  BIND_SESSIONKEYALG
  BIND_PORT
  BIND_RANDOMDEVICE
  BIND_VERSION
  BIND_LISTENONPORT
  BIND_LISTENON
  BIND_LISTENONPORTV6
  BIND_LISTENONV6
  BIND_AUTOMATICINTERFACESCAN
  BIND_ALLOWNEWZONES
  BIND_FLUSHZONESONSHUTDOWN
  BIND_GEOIPUSEECS
  BIND_ROOTKEYSENTINEL
  BIND_MESSAGECOMPRESSION
  BIND_MINIMALRESPONSES
  BIND_MINIMALANY
  BIND_NOTIFY
  BIND_RECURSION
  BIND_REQUESTNSID
  BIND_ANSWERCOOKIE
  BIND_NOCOOKIEUDPSIZE
  BIND_COOKIEALGORITHM
  BIND_ADDITIONALFROMAUTH
  BIND_ADDITIONALFROMCACHE
  BIND_FILTERAAAAONV4
  BIND_FILTERAAAAONV6
  BIND_IXFRFROMDIFFERENCES
  BIND_MULTIMASTER
  BIND_AUTODNSSEC
  BIND_DNSSECVALIDATION
  BIND_DNSSECENABLE
  BIND_DNSSECACCEPTEXPIRED
  BIND_CHECKNAMESMASTER
  BIND_CHECKNAMESSLAVE
  BIND_CHECKNAMESRESPONSE
  BIND_CHECKDUPRECORDS
  BIND_CHECKMX
  BIND_CHECKWILDCARD
  BIND_CHECKINTEGRITY
  BIND_CHECKMXCNAME
  BIND_CHECKSRVCNAME
  BIND_CHECKSIBLING
  BIND_CHECKSPF
  BIND_ZERONOSOATTL
  BIND_ZERONOSOATTLCACHE
  BIND_UPDATECHECKKSK
  BIND_DNSSECDNSKEYKSKONLY
  BIND_TRYTCPREFRESH
  BIND_DNSSECSECURETOINSECURE
)

echo -n "==> Setting config vars ... "
for c in ${CONFIGS_VARS[@]}
do
  sed -i "s,@@${c}@@,$(eval echo \$${c})," /etc/bind/rndc.key
  sed -i "s,@@${c}@@,$(eval echo \$${c})," /etc/bind/named.conf.options
done
echo "Done"

echo "==> Starting bind9"
named -g -u bind -c /etc/bind/named.conf
