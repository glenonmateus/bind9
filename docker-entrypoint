#!/usr/bin/env bash

# creating secret rndc.key
# openssl rand -base64 15

: ${BIND_RNDCKEY:="D9yVnKTEXtrdHA=="}
# options Statement Definition and Usage
: ${BIND_ATTACHCACHE:=""}
: ${BIND_DIRECTORY:="/var/cache/bind/"}
: ${BIND_DNSTAP:=""}
: ${BIND_DNSTAPOUTPUT:=""}
: ${BIND_DNSTAPIDENTIFY:=""}
: ${BIND_DNSTAPVERSION:=""}
: ${BIND_GEOIPDIRECTORY:=""}
: ${BIND_KEYDIRECTORY:=""}
: ${BIND_LMDBMAPSIZE:=""}
: ${BIND_MANAGEDKEYSDIRECTORY:=""}
: ${BIND_NAMEDXFER:=""}
: ${BIND_TKEYGSSAPIKEYTAB:=""}
: ${BIND_TKEYGSSAPICREDENTIAL:=""}
: ${BIND_TKEYDOMAIN:=""}
: ${BIND_TKEYDHKEY:=""}
: ${BIND_CACHEFILE:=""}
: ${BIND_DUMPFILE:=""}
: ${BIND_MEMSTATISTICSFILE:=""}
: ${BIND_LOCKFILE:=""}
: ${BIND_PIDFILE:=""}
: ${BIND_RECURSINGFILE:=""}
: ${BIND_STATISTICSFILE:=""}
: ${BIND_BINDKEYSFILE:=""}
: ${BIND_SECROOTSFILE:=""}
: ${BIND_SESSIONKEYFILE:=""}
: ${BIND_SESSIONKEYNAME:=""}
: ${BIND_SESSIONKEYALG:=""}
: ${BIND_PORT:=""}
: ${BIND_DSCP:=""}
: ${BIND_RANDOMDEVICE:=""}
: ${BIND_PREFERREDGLUE:=""}
: ${BIND_ROOTDELEGATIONONLY:=""}
: ${BIND_DISABLEALGORITHMS:=""}
: ${BIND_DISABLEDSDIGESTS:=""}
: ${BIND_DNSSECLOOKASIDE:=""}
: ${BIND_DNSSECMUSTBESECURE:=""}
: ${BIND_DNS64:=""}
: ${BIND_DNSSECLOADKEYSINTERVAL:=""}
: ${BIND_DNSSECUPDATEMODE:=""}
: ${BIND_NTALIFETIME:=""}
: ${BIND_NTARECHECK:=""}
: ${BIND_MAXZONETTL:=""}
: ${BIND_SERIALUPDATEMETHOD:=""}
: ${BIND_ZONESTATISTICS:=""}
# Boolean Options
: ${BIND_AUTOMATICINTERFACESCAN:=""}
: ${BIND_ALLOWNEWZONES:=""}
: ${BIND_AUTHNXDOMAIN:=""}
: ${BIND_MEMSTATISTICS:=""}
: ${BIND_DIALUP:=""}
: ${BIND_FLUSHZONESONSHUTDOWN:=""}
: ${BIND_GEOIPUSEECS:=""}
: ${BIND_ROOTKEYSENTINEL:=""}
: ${BIND_MESSAGECOMPRESSION:=""}
: ${BIND_MINIMALRESPONSES:=""}
: ${BIND_MINIMALANY:=""}
: ${BIND_NOTIFY:=""}
: ${BIND_NOTIFYTOSOA:=""}
: ${BIND_RECURSION:=""}
: ${BIND_REQUESTNSID:=""}
: ${BIND_REQUIRESERVERCOOKIE:=""}
: ${BIND_ANSWERCOOKIE:=""}
: ${BIND_SENDCOOKIE:=""}
: ${BIND_NOCOOKIEUDPSIZE:=""}
: ${BIND_COOKIEALGORITHM:=""}
: ${BIND_COOKIESECRET:=""}
: ${BIND_TRUSTANCHORTELEMETRY:=""}
: ${BIND_PROVIDEIXFR:=""}
: ${BIND_REQUESTIXFR:=""}
: ${BIND_REQUESTEXPIRE:=""}
: ${BIND_ADDITIONALFROMAUTH:=""}
: ${BIND_ADDITIONALFROMCACHE:=""}
: ${BIND_MATCHMAPPEDADDRESSES:=""}
: ${BIND_FILTERAAAAONV4:=""}
: ${BIND_FILTERAAAAONV6:=""}
: ${BIND_IXFRFROMDIFFERENCES:=""}
: ${BIND_MULTIMASTER:=""}
: ${BIND_AUTODNSSEC:=""}
: ${BIND_DNSSECENABLE:=""}
: ${BIND_DNSSECVALIDATION:="auto"}
: ${BIND_DNSSECACCEPTEXPIRED:=""}
: ${BIND_QUERYLOG:=""}
: ${BIND_CHECKNAMESMASTER:=""}
: ${BIND_CHECKNAMESSLAVE:=""}
: ${BIND_CHECKNAMESRESPONSE:=""}
: ${BIND_CHECKDUPRECORDS:=""}
: ${BIND_CHECKMX:=""}
: ${BIND_CHECKWILDCARD:=""}
: ${BIND_CHECKINTEGRITY:=""}
: ${BIND_CHECKMXCNAME:=""}
: ${BIND_CHECKSRVCNAME:=""}
: ${BIND_CHECKSIBLING:=""}
: ${BIND_CHECKSPF:=""}
: ${BIND_ZERONOSOATTL:=""}
: ${BIND_ZERONOSOATTLCACHE:=""}
: ${BIND_UPDATECHECKKSK:=""}
: ${BIND_DNSSECDNSKEYKSKONLY:=""}
: ${BIND_TRYTCPREFRESH:=""}
: ${BIND_DNSSECSECURETOINSECURE:=""}
# Forwarding
: ${BIND_FORWARD:=""}
: ${BIND_FORWARDERS:=""}
# Interfaces
: ${BIND_LISTENONPORT:="53 { any; }"}
: ${BIND_LISTENONPORTV6:="53 { none; }"}
: ${BIND_VERSION:="none"}

CONFIGS_VARS=(
  BIND_RNDCKEY
  BIND_ATTACHCACHE
  BIND_DIRECTORY
  BIND_DNSTAP
  BIND_DNSTAPOUTPUT
  BIND_DNSTAPIDENTIFY
  BIND_DNSTAPVERSION
  BIND_GEOIPDIRECTORY
  BIND_KEYDIRECTORY
  BIND_LMDBMAPSIZE
  BIND_MANAGEDKEYSDIRECTORY
  BIND_NAMEDXFER
  BIND_TKEYGSSAPIKEYTAB
  BIND_TKEYGSSAPICREDENTIAL
  BIND_TKEYDOMAIN
  BIND_TKEYDHKEY
  BIND_CACHEFILE
  BIND_DUMPFILE
  BIND_MEMSTATISTICSFILE
  BIND_LOCKFILE
  BIND_PIDFILE
  BIND_RECURSINGFILE
  BIND_STATISTICSFILE
  BIND_BINDKEYSFILE
  BIND_SECROOTSFILE
  BIND_SESSIONKEYFILE
  BIND_SESSIONKEYNAME
  BIND_SESSIONKEYALG
  BIND_PORT
  BIND_DSCP
  BIND_RANDOMDEVICE
  BIND_PREFERREDGLUE
  BIND_ROOTDELEGATIONONLY
  BIND_DISABLEALGORITHMS
  BIND_DISABLEDSDIGESTS
  BIND_DNSSECLOOKASIDE
  BIND_DNSSECMUSTBESECURE
  BIND_DNS64
  BIND_DNSSECLOADKEYSINTERVAL
  BIND_DNSSECUPDATEMODE
  BIND_NTALIFETIME
  BIND_NTARECHECK
  BIND_MAXZONETTL
  BIND_SERIALUPDATEMETHOD
  BIND_ZONESTATISTICS
  BIND_AUTOMATICINTERFACESCAN
  BIND_ALLOWNEWZONES
  BIND_AUTHNXDOMAIN
  BIND_MEMSTATISTICS
  BIND_DIALUP
  BIND_FLUSHZONESONSHUTDOWN
  BIND_GEOIPUSEECS
  BIND_ROOTKEYSENTINEL
  BIND_MESSAGECOMPRESSION
  BIND_MINIMALRESPONSES
  BIND_MINIMALANY
  BIND_NOTIFY
  BIND_NOTIFYTOSOA
  BIND_RECURSION
  BIND_REQUESTNSID
  BIND_REQUIRESERVERCOOKIE
  BIND_ANSWERCOOKIE
  BIND_SENDCOOKIE
  BIND_NOCOOKIEUDPSIZE
  BIND_COOKIEALGORITHM
  BIND_COOKIESECRET
  BIND_TRUSTANCHORTELEMETRY
  BIND_PROVIDEIXFR
  BIND_REQUESTIXFR
  BIND_REQUESTEXPIRE
  BIND_ADDITIONALFROMAUTH
  BIND_ADDITIONALFROMCACHE
  BIND_MATCHMAPPEDADDRESSES
  BIND_FILTERAAAAONV4
  BIND_FILTERAAAAONV6
  BIND_IXFRFROMDIFFERENCES
  BIND_MULTIMASTER
  BIND_AUTODNSSEC
  BIND_DNSSECENABLE
  BIND_DNSSECVALIDATION
  BIND_DNSSECACCEPTEXPIRED
  BIND_QUERYLOG
  BIND_CHECKNAMESMASTER
  BIND_CHECKNAMESSLAVE
  BIND_CHECKNAMESRESPONSE
  BIND_CHECKDUPRECORDS
  BIND_CHECKMX
  BIND_CHECKWILDCARD
  BIND_CHECKINTEGRITY
  BIND_CHECKMXCNAME
  BIND_CHECKSRVCNAME
  BIND_CHECKSIBLING
  BIND_CHECKSPF
  BIND_ZERONOSOATTL
  BIND_ZERONOSOATTLCACHE
  BIND_UPDATECHECKKSK
  BIND_DNSSECDNSKEYKSKONLY
  BIND_TRYTCPREFRESH
  BIND_DNSSECSECURETOINSECURE
  BIND_FORWARD
  BIND_FORWARDERS
  BIND_LISTENONPORT
  BIND_LISTENONPORTV6
  BIND_VERSION
)
#sed -i "s,${c},$(eval echo \$${c})," /etc/bind/rndc.key

OPTIONS=/etc/bind/named.conf.options
echo -n "==> Setting configurations options ... "
echo "options {" > $OPTIONS
for c in ${CONFIGS_VARS[@]}
do
  if [[ $(eval echo \$${c}) ]]; then
    grep -w ${c} options >> $OPTIONS
    sed -i "s,${c},$(eval echo \$${c})," $OPTIONS
  fi
done
echo "};" >> $OPTIONS
echo "Done"

cat $OPTIONS

echo "==> Starting bind9"
named -g -u bind -c /etc/bind/named.conf
